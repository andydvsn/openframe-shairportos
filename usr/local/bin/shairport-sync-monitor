#!/bin/bash

## shairport-sync-monitor v1.02 (20th July 2015) by Andy Davison
##  Watches the output of shairport-sync-metadata-reader and does stuff.

while true ; do

	if [ -e /tmp/shairport-sync/image ]; then

		ofscreen on 0 &

		CHECK=`md5sum /tmp/shairport-sync/image`

		if [ ! "$CURRENT" ] || [ "$CURRENT" != "$CHECK" ]; then
			base64 -d /tmp/shairport-sync/image > /tmp/shairport-sync/artwork
			convert /tmp/shairport-sync/artwork -resize 25% -brightness-contrast -30x-30 -blur 8x8 -resize 400% /tmp/shairport-sync/artwork_blur.jpg
			echo "$CHECK" > /tmp/shairport-sync/ready
			CURRENT="$CHECK"
		fi

	else

		rm /tmp/shairport-sync/artwork* &>/dev/null
		ofscreen off 16 &

	fi

	sleep 0.3

done
